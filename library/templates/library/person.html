{% extends 'base.html' %}
{% load static %}

{% block title %}{{ person_details.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-4 col-lg-3">
      <div class="mb-4">
        {% if person_details.profile_path %}
          <img src="https://image.tmdb.org/t/p/w500{{ person_details.profile_path }}"
               alt="{{ person_details.name }}"
               class="img-fluid rounded shadow-lg"
               loading="lazy">
        {% else %}
          <div class="bg-secondary rounded d-flex align-items-center justify-content-center shadow-lg" style="height: 500px;">
            <i class="bi bi-person-circle display-1 text-light"></i>
          </div>
        {% endif %}
      </div>

      <div class="card border-0 bg-light">
        <div class="card-body">
          {% if person_details.known_for_department %}
            <div class="mb-3">
              <div class="fw-semibold small">Known For</div>
              <div class="small">{{ person_details.known_for_department }}</div>
            </div>
          {% endif %}

          {% with movie_credits|length as movie_count %}
            {% with tv_credits|length as tv_count %}
            <div class="mb-3">
              <div class="fw-semibold small">Known Credits</div>
              <div class="small">{{ movie_count|add:tv_count }}</div>
            </div>
            {% endwith %}
          {% endwith %}


          {% if person_details.gender %}
            <div class="mb-3">
              <div class="fw-semibold small">Gender</div>
              <div class="small">
                {% if person_details.gender == 1 %}Female
                {% elif person_details.gender == 2 %}Male
                {% else %}Not specified{% endif %}
              </div>
            </div>
          {% endif %}

          {% if person_details.birthday %}
            <div class="mb-3">
              <div class="fw-semibold small">Birthday</div>
              <div class="small">{{ person_details.birthday }}</div>
            </div>
          {% endif %}

          {% if person_details.place_of_birth %}
            <div class="mb-3">
              <div class="fw-semibold small">Place of Birth</div>
              <div class="small">{{ person_details.place_of_birth }}</div>
            </div>
          {% endif %}

          {% if person_details.also_known_as %}
            <div class="mb-3">
              <div class="fw-semibold small">Also Known As</div>
              <div class="small">
                {% for alias in person_details.also_known_as %}
                  {{ alias }}{% if not forloop.last %}<br>{% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-8 col-lg-9">
      <h1 class="display-6 fw-bold mb-4">{{ person_details.name }}</h1>

      {% if person_details.biography %}
        <div class="mb-5">
          <h5 class="fw-bold">Biography</h5>
          <div class="position-relative">
            <div id="biography" class="fs-6 biography-text collapsed" style="
              text-align: justify;
              max-height: 170px;
              overflow: hidden;
              position: relative;
              transition: max-height 0.3s ease;
            ">
              {{ person_details.biography }}
              <div class="fade-out" style="
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 2em;
                background: linear-gradient(to bottom, transparent, white);
              "></div>
            </div>
            <div class="text-end mt-2">
             <button id="toggleBiographyBtn" class="btn btn-outline-secondary btn-sm d-none">Read more</button>
            </div>
          </div>
        </div>
        {% else %}
           <div class="mb-5">
             <h5 class="fw-bold">Biography</h5>
             <p class="text-muted fst-italic fs-6">
               We don't have a biography for {{ person_details.name }}.
             </p>
           </div>
        {% endif %}

      <div class="mb-5">
        <h5 class="fw-bold mb-3">Known For</h5>

        <ul class="nav nav-tabs mb-4" id="creditsTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="movies-tab" data-bs-toggle="tab" data-bs-target="#movies" type="button" role="tab">
              Movies <span class="badge bg-secondary ms-1">{{ movie_credits|length }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tv-tab" data-bs-toggle="tab" data-bs-target="#tv" type="button" role="tab">
              TV Shows <span class="badge bg-secondary ms-1">{{ tv_credits|length }}</span>
            </button>
          </li>
        </ul>

        <div class="tab-content" id="creditsTabContent">
          <div class="tab-pane fade show active" id="movies" role="tabpanel">
            {% if movie_credits %}
              <div class="row g-3">
                {% for credit in movie_credits %}
                  <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="card border-0 shadow-sm h-100">
                      <a href="{% url 'movie_details' media_id=credit.id %}" class="text-decoration-none">
                        {% if credit.poster_path %}
                          <img src="https://image.tmdb.org/t/p/w300{{ credit.poster_path }}"
                               class="card-img-top"
                               alt="{{ credit.title }}"
                               style="height: 200px; object-fit: cover; border-radius: 8px 8px 0 0;">
                        {% else %}
                          <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px; border-radius: 8px 8px 0 0;">
                            <i class="bi bi-film fs-2 text-muted"></i>
                          </div>
                        {% endif %}
                        <div class="card-body p-3">
                          <h6 class="text-center card-title fw-bold mb-2 text-dark" style="font-size: 0.9rem;">{{ credit.title }}</h6>
                          {% if credit.combined_roles %}
                            <div class="mb-2 px-2 py-1 bg-light rounded-2">
                              <small class="text-primary fw-semibold d-block text-center" style="font-size: 0.75rem; line-height: 1.2;">
                                {{ credit.combined_roles|truncatechars:60 }}
                              </small>
                            </div>
                          {% endif %}
                          <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ credit.release_date|slice:":4"|default:"Unknown" }}</small>
                            {% if credit.vote_average %}
                              <small class="text-warning">⭐ {{ credit.vote_average|floatformat:1 }}</small>
                            {% endif %}
                          </div>
                        </div>
                      </a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-5">
                <i class="bi bi-film display-1 text-muted mb-3"></i>
                <p class="text-muted fs-5">No movie credits found</p>
              </div>
            {% endif %}
          </div>

          <div class="tab-pane fade" id="tv" role="tabpanel">
            {% if tv_credits %}
              <div class="row g-3">
                {% for credit in tv_credits %}
                  <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="card border-0 shadow-sm h-100">
                      <a href="{% url 'tv_details' media_id=credit.id %}" class="text-decoration-none">
                        {% if credit.poster_path %}
                          <img src="https://image.tmdb.org/t/p/w300{{ credit.poster_path }}"
                               class="card-img-top"
                               alt="{{ credit.title }}"
                               style="height: 200px; object-fit: cover; border-radius: 8px 8px 0 0;">
                        {% else %}
                          <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px; border-radius: 8px 8px 0 0;">
                            <i class="bi bi-tv fs-2 text-muted"></i>
                          </div>
                        {% endif %}
                        <div class="card-body p-3">
                          <h6 class="text-center card-title fw-bold mb-2 text-dark" style="font-size: 0.9rem;">{{ credit.title }}</h6>
                          {% if credit.combined_roles %}
                            <div class="mb-2 px-2 py-1 bg-light rounded-2">
                              <small class="text-primary fw-semibold d-block text-center" style="font-size: 0.75rem; line-height: 1.2;">
                                {{ credit.combined_roles|truncatechars:60 }}
                              </small>
                            </div>
                          {% endif %}
                          <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ credit.release_date|slice:":4"|default:"Unknown" }}</small>
                            {% if credit.vote_average %}
                              <small class="text-warning">⭐ {{ credit.vote_average|floatformat:1 }}</small>
                            {% endif %}
                          </div>
                        </div>
                      </a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-5">
                <i class="bi bi-tv display-1 text-muted mb-3"></i>
                <p class="text-muted fs-5">No TV show credits found</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'library/js/person.js' %}"></script>
{% endblock %}
